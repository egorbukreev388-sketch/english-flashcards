<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English AI - Economics Edition</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --accent: #8b5cf6;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --blue: #38bdf8;
            --green: #22c55e;
            --red: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 480px; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Tabs */
        .tabs { display: flex; background: var(--card-bg); padding: 5px; border-radius: 15px; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; border: none; background: none; color: var(--text-dim); padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .tab-btn.active { background: var(--accent); color: white; }

        /* Screens */
        .screen { display: none; flex-direction: column; gap: 20px; width: 100%; }
        .screen.active { display: flex; }

        /* Card Mode */
        .card-box { perspective: 1000px; height: 320px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-box.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--card-bg); border-radius: 25px; border: 1px solid rgba(139, 92, 246, 0.2); padding: 25px; text-align: center; }
        .card-back { transform: rotateY(180deg); background: linear-gradient(135deg, #1e293b, #2e1065); }
        .word-en { font-size: 2.2rem; color: var(--blue); font-weight: bold; margin-bottom: 10px; }
        .word-ru { font-size: 1.6rem; color: var(--text); line-height: 1.3; }

        /* Quiz UI */
        .question-card { background: var(--card-bg); padding: 30px; border-radius: 20px; text-align: center; font-size: 1.4rem; min-height: 120px; display: flex; align-items: center; justify-content: center; line-height: 1.4; border: 1px solid rgba(255,255,255,0.05); }
        .options-grid { display: grid; gap: 12px; }
        .option-btn { background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1); color: var(--text); padding: 18px; border-radius: 12px; cursor: pointer; font-size: 1.05rem; transition: 0.2s; }
        .option-btn.correct { background: var(--green); border-color: var(--green); color: white; }
        .option-btn.wrong { background: var(--red); border-color: var(--red); color: white; }
        .progress-footer { text-align: center; margin-top: 15px; color: var(--text-dim); font-size: 0.9rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }

        /* AI Screen */
        .ai-input { background: var(--card-bg); border: 1px solid var(--accent); color: white; padding: 15px; border-radius: 15px; height: 160px; width: 100%; resize: none; font-size: 1rem; }
        .primary-btn { background: var(--accent); color: white; border: none; padding: 18px; border-radius: 15px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1.1rem; }
        .primary-btn:disabled { opacity: 0.5; }
        
        .hidden { display: none !important; }
        .nav-controls { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
        .nav-btn { background: var(--card-bg); border: 1px solid var(--accent); color: white; width: 55px; height: 55px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="color: var(--accent)">English <span style="color:white">Pro</span></h2>
        <span id="share-link" class="hidden" onclick="copyLink()" style="color: var(--blue); cursor: pointer; font-size: 0.8rem;">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è üîó</span>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('learn', this)">–£—á–∏—Ç—å</button>
        <button class="tab-btn" onclick="switchTab('train', this)">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
        <button class="tab-btn" onclick="switchTab('test', this)">–¢–µ—Å—Ç</button>
        <button class="tab-btn" onclick="switchTab('ai', this)">–ò–ò</button>
    </div>
    <!-- –û—Å—Ç–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π HTML, –Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤ test-results –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ -->
    <div id="test-results" class="hidden" style="text-align: center; padding: 40px 20px;">
        <h1 style="font-size: 4rem; color: var(--accent)" id="test-score-val">0%</h1>
        <p style="color: var(--text-dim); margin-bottom: 30px;">–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å–ª–æ–≤–∞ —Å –æ—à–∏–±–∫–∞–º–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        <button class="primary-btn" onclick="initTest()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç</button>
    </div>
    <!-- Screen: Learn -->
    <section id="learn-screen" class="screen active">
        <div class="card-box" onclick="this.classList.toggle('flipped')">
            <div class="card-inner">
                <div class="card-front">
                    <div class="word-en" id="learn-en">Ready?</div>
                </div>
                <div class="card-back">
                    <div class="word-ru" id="learn-ru">–ì–æ—Ç–æ–≤? –ó–∞–π–¥–∏ –≤ —Ä–µ–∂–∏–º –ò–ò</div>
                </div>
            </div>
        </div>
        <div class="nav-controls">
            <button class="nav-btn" onclick="prevCard()">‚Üê</button>
            <span id="learn-counter" style="font-weight: bold">0 / 0</span>
            <button class="nav-btn" onclick="nextCard()">‚Üí</button>
        </div>
    </section>

    <!-- Screen: Train -->
    <section id="train-screen" class="screen">
        <div class="question-card" id="train-q">...</div>
        <div class="options-grid" id="train-options"></div>
    </section>

    <!-- Screen: Test -->
    <section id="test-screen" class="screen">
        <div id="test-content">
            <div class="question-card" id="test-q">...</div>
            <div class="options-grid" id="test-options" style="margin-top: 20px"></div>
            <div class="progress-footer" id="test-counter-footer">–í–æ–ø—Ä–æ—Å 1 –∏–∑ 10</div>
        </div>
        <div id="test-results" class="hidden" style="text-align: center; padding: 40px 20px;">
            <h1 style="font-size: 4rem; color: var(--accent)" id="test-score-val">0%</h1>
            <p style="color: var(--text-dim); margin-bottom: 30px;">–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
            <button class="primary-btn" onclick="initTest()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç</button>
        </div>
    </section>

    <!-- Screen: AI -->
    <section id="ai-screen" class="screen">
        <textarea id="ai-input" class="ai-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '25 —Å–ª–æ–≤ –ø—Ä–æ –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫—É' –∏–ª–∏ '10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π'"></textarea>
        <button class="primary-btn" id="ai-btn" onclick="generateAI()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <div id="loader" class="hidden" style="text-align: center; color: var(--blue);">–°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏... ‚ú®</div>
    </section>
</div>

<script>
    // --- FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyB0rdcOyeV1nOGNHueIBFRBD9qFvZl4LXM",
        authDomain: "slova-2581b.firebaseapp.com",
        projectId: "slova-2581b",
        storageBucket: "slova-2581b.firebasestorage.app",
        messagingSenderId: "721297377916",
        appId: "1:721297377916:web:04b2aa9adb0c5e2e3cd7f9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- STATE ---
    let words = [{english: "Start", russian: "–ù–∞—á–Ω–∏ –≤ —Ä–µ–∂–∏–º–µ –ò–ò"}];
    let currentIndex = 0;
    let testData = { current: 0, score: 0, pool: [], wrongAnswers: [] }; // –î–æ–±–∞–≤–ª–µ–Ω wrongAnswers

    // --- UI NAVIGATION ---
    function switchTab(name, btn) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(name + '-screen').classList.add('active');
        btn.classList.add('active');
        if(name === 'train') initTraining();
        if(name === 'test') initTest();
    }

    // --- LEARN LOGIC ---
    function updateLearn() {
        if(!words.length) return;
        const w = words[currentIndex];
        document.getElementById('learn-en').innerText = w.english;
        document.getElementById('learn-ru').innerText = w.russian;
        document.getElementById('learn-counter').innerText = `${currentIndex + 1} / ${words.length}`;
        document.querySelector('.card-box').classList.remove('flipped');
    }
    function nextCard() { if(currentIndex < words.length - 1) { currentIndex++; updateLearn(); } }
    function prevCard() { if(currentIndex > 0) { currentIndex--; updateLearn(); } }

    // --- TRAINING LOGIC ---
    function initTraining() {
        if(words.length < 2) return document.getElementById('train-q').innerText = "–ú–∞–ª–æ —Å–ª–æ–≤";
        const correct = words[Math.floor(Math.random() * words.length)];
        document.getElementById('train-q').innerText = correct.russian;
        let opts = [correct.english];
        while(opts.length < 4 && opts.length < words.length) {
            let r = words[Math.floor(Math.random() * words.length)].english;
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5);
        const grid = document.getElementById('train-options');
        grid.innerHTML = '';
        opts.forEach(o => {
            const b = document.createElement('button');
            b.className = 'option-btn';
            b.innerText = o;
            b.onclick = () => {
                if(o === correct.english) { b.classList.add('correct'); setTimeout(initTraining, 800); }
                else { b.classList.add('wrong'); }
            };
            grid.appendChild(b);
        });
    }

    // --- TEST LOGIC (Updated UI) ---
    function initTest() {
        testData = { 
            current: 0, 
            score: 0, 
            pool: [...words].sort(() => Math.random() - 0.5).slice(0, 20), // –ò–∑–º–µ–Ω–µ–Ω–æ —Å 10 –Ω–∞ 20
            wrongAnswers: [] // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
        };
        document.getElementById('test-content').classList.remove('hidden');
        document.getElementById('test-results').classList.add('hidden');
        renderTestStep();
    }
    
    function renderTestStep() {
        if(testData.current >= testData.pool.length) {
            document.getElementById('test-content').classList.add('hidden');
            document.getElementById('test-results').classList.remove('hidden');
            const percentage = Math.round((testData.score / testData.pool.length) * 100);
            document.getElementById('test-score-val').innerText = percentage + "%";
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ª–æ–≤–∞ —Å –æ—à–∏–±–∫–∞–º–∏
            const resultsContainer = document.getElementById('test-results');
            const wrongAnswersSection = document.getElementById('wrong-answers-section');
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            const oldWrongSection = document.getElementById('wrong-answers-section');
            if (oldWrongSection) oldWrongSection.remove();
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª —Å –æ—à–∏–±–∫–∞–º–∏
            if (testData.wrongAnswers.length > 0) {
                const wrongSection = document.createElement('div');
                wrongSection.id = 'wrong-answers-section';
                wrongSection.style.marginTop = '30px';
                wrongSection.style.textAlign = 'left';
                
                const title = document.createElement('h3');
                title.textContent = '–°–ª–æ–≤–∞ —Å –æ—à–∏–±–∫–∞–º–∏:';
                title.style.color = 'var(--red)';
                title.style.marginBottom = '15px';
                title.style.fontSize = '1.2rem';
                
                wrongSection.appendChild(title);
                
                testData.wrongAnswers.forEach(item => {
                    const card = document.createElement('div');
                    card.style.background = 'var(--card-bg)';
                    card.style.padding = '15px';
                    card.style.borderRadius = '12px';
                    card.style.marginBottom = '10px';
                    card.style.border = '1px solid var(--red)';
                    
                    const englishWord = document.createElement('div');
                    englishWord.textContent = `üî¥ ${item.question}`;
                    englishWord.style.color = 'var(--text)';
                    englishWord.style.fontWeight = 'bold';
                    englishWord.style.marginBottom = '5px';
                    
                    const correctAnswer = document.createElement('div');
                    correctAnswer.textContent = `‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${item.correct}`;
                    correctAnswer.style.color = 'var(--green)';
                    correctAnswer.style.fontSize = '0.9rem';
                    
                    card.appendChild(englishWord);
                    card.appendChild(correctAnswer);
                    wrongSection.appendChild(card);
                });
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ —Å—á–µ—Ç–∞, –Ω–æ –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π
                const scoreElement = document.getElementById('test-score-val').parentElement;
                const button = resultsContainer.querySelector('.primary-btn');
                resultsContainer.insertBefore(wrongSection, button);
            }
            return;
        }
    
    const w = testData.pool[testData.current];
    document.getElementById('test-q').innerText = w.russian;
    document.getElementById('test-counter-footer').innerText = `–í–æ–ø—Ä–æ—Å ${testData.current + 1} –∏–∑ ${testData.pool.length}`;
    
    let opts = [w.english];
    while(opts.length < 4 && opts.length < words.length) {
        let r = words[Math.floor(Math.random() * words.length)].english;
        if(!opts.includes(r)) opts.push(r);
    }
    opts.sort(() => Math.random() - 0.5);
    
    const grid = document.getElementById('test-options');
    grid.innerHTML = '';
    
    opts.forEach(o => {
        const b = document.createElement('button');
        b.className = 'option-btn';
        b.innerText = o;
        b.onclick = () => {
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π
            if(o !== w.english) {
                testData.wrongAnswers.push({
                    question: w.russian,
                    correct: w.english
                });
            } else {
                testData.score++;
            }
            testData.current++;
            renderTestStep();
        };
        grid.appendChild(b);
    });
}

    // --- AI LOGIC (Updated Prompting) ---
    async function generateAI() {
        const promptInput = document.getElementById('ai-input');
        const prompt = promptInput.value.trim();
        if(!prompt) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤ –∏–ª–∏ —Ç–µ–º—É");
        
        const btn = document.getElementById('ai-btn');
        const loader = document.getElementById('loader');
        btn.classList.add('hidden');
        loader.classList.remove('hidden');

        try {
            const res = await fetch('/api/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ prompt: prompt })
            });
            
            const data = await res.json();
            
            if (data.error) {
                alert("–û—à–∏–±–∫–∞: " + data.error);
                return;
            }

            if(data.words && Array.isArray(data.words)) {
                words = data.words;
                currentIndex = 0;
                saveSet(data.words); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
                updateLearn();
                switchTab('learn', document.querySelectorAll('.tab-btn')[0]);
                promptInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
            } else {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –æ—Ç–≤–µ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.");
            }
        } catch (e) { 
            console.error(e);
            alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å –æ–±—ä–µ–º —Ç–µ–∫—Å—Ç–∞."); 
        } finally { 
            btn.classList.remove('hidden'); 
            loader.classList.add('hidden'); 
        }
    }

    // --- FIREBASE SAVE/LOAD ---
    async function saveSet(arr) {
        const doc = await db.collection('flashcard-sets').add({ words: arr, createdAt: new Date() });
        const url = window.location.origin + window.location.pathname + '?id=' + doc.id;
        window.history.pushState({}, '', url);
        document.getElementById('share-link').classList.remove('hidden');
    }

    async function loadSet(id) {
        const doc = await db.collection('flashcard-sets').doc(id).get();
        if(doc.exists) { words = doc.data().words; currentIndex = 0; updateLearn(); document.getElementById('share-link').classList.remove('hidden'); }
    }

    function copyLink() { navigator.clipboard.writeText(window.location.href); alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"); }

    window.onload = () => {
        const id = new URLSearchParams(window.location.search).get('id');
        if(id) loadSet(id); else updateLearn();
    };
</script>

</body>
</html>


