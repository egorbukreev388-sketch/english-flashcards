<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English AI Flashcards</title>
    <!-- Firebase SDK (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --blue: #38bdf8;
            --green: #22c55e;
            --red: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            overflow-x: hidden;
        }

        .container { 
            width: 100%; 
            max-width: 450px; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px;
        }

        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0;
        }

        .share-btn { 
            background: none; 
            border: 1px solid var(--blue); 
            color: var(--blue); 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            cursor: pointer;
        }

        /* Tabs */
        .tabs { 
            display: flex; 
            background: var(--card-bg); 
            padding: 5px; 
            border-radius: 15px; 
            gap: 5px;
        }
        .tab-btn { 
            flex: 1; 
            border: none; 
            background: none; 
            color: var(--text-dim); 
            padding: 10px; 
            border-radius: 10px; 
            font-weight: bold; 
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.3s;
        }
        .tab-btn.active { background: var(--accent); color: white; }

        /* Screens */
        .screen { display: none; flex-direction: column; gap: 20px; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Flashcard */
        .card-box { perspective: 1000px; height: 320px; cursor: pointer; }
        .card-inner { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            transition: transform 0.6s; 
            transform-style: preserve-3d; 
        }
        .card-box.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            background: var(--card-bg); 
            border-radius: 25px; 
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .card-back { transform: rotateY(180deg); background: linear-gradient(135deg, #1e293b, #2e1065); }
        .word-en { font-size: 2.2rem; font-weight: bold; color: var(--blue); margin-bottom: 10px; }
        .word-ru { font-size: 1.6rem; color: var(--text); }

        /* Controls */
        .nav-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .round-btn { 
            background: var(--card-bg); 
            border: 1px solid var(--accent); 
            color: white; 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Quiz/Training */
        .question-card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 20px; 
            text-align: center; 
            font-size: 1.3rem;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .options-grid { display: grid; gap: 12px; margin-top: 10px; }
        .option-btn { 
            background: var(--card-bg); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: var(--text); 
            padding: 16px; 
            border-radius: 12px; 
            cursor: pointer; 
            text-align: center;
            font-size: 1rem;
            transition: 0.2s;
        }
        .option-btn:active { transform: scale(0.98); }
        .option-btn.correct { background: var(--green); border-color: var(--green); color: white; }
        .option-btn.wrong { background: var(--red); border-color: var(--red); color: white; }

        /* AI Screen */
        .ai-textarea { 
            background: var(--card-bg); 
            border: 1px solid var(--accent); 
            color: white; 
            padding: 15px; 
            border-radius: 15px; 
            height: 180px; 
            width: 100%; 
            resize: none;
            font-size: 1rem;
        }
        .primary-btn { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 18px; 
            border-radius: 15px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%;
            font-size: 1rem;
        }
        .primary-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .hidden { display: none !important; }
        #loader { text-align: center; color: var(--blue); margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2 style="color: var(--accent)">English <span style="color:white">AI</span></h2>
        <button id="share-link" class="share-btn hidden" onclick="copyLink()">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('learn', this)">–£—á–∏—Ç—å</button>
        <button class="tab-btn" onclick="switchTab('train', this)">–¢—Ä–µ–Ω—è</button>
        <button class="tab-btn" onclick="switchTab('test', this)">–¢–µ—Å—Ç</button>
        <button class="tab-btn" onclick="switchTab('ai', this)">–ò–ò</button>
    </div>

    <!-- –†–µ–∂–∏–º: –£—á–µ–±–∞ -->
    <section id="learn-screen" class="screen active">
        <div class="card-box" onclick="this.classList.toggle('flipped')">
            <div class="card-inner">
                <div class="card-front">
                    <div class="word-en" id="learn-en">Welcome!</div>
                    <div style="font-size: 0.8rem; color: var(--text-dim)">–Ω–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É</div>
                </div>
                <div class="card-back">
                    <div class="word-ru" id="learn-ru">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
                </div>
            </div>
        </div>
        <div class="nav-controls">
            <button class="round-btn" onclick="prevCard()">‚Üê</button>
            <span id="learn-counter" style="font-weight: bold">1 / 1</span>
            <button class="round-btn" onclick="nextCard()">‚Üí</button>
        </div>
        <p style="text-align: center; font-size: 0.8rem; color: var(--text-dim); margin-top: 10px;">
            –ó–∞–π–¥–∏—Ç–µ –≤ —Ä–µ–∂–∏–º –ò–ò, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤.
        </p>
    </section>

    <!-- –†–µ–∂–∏–º: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ -->
    <section id="train-screen" class="screen">
        <div class="question-card" id="train-q">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="options-grid" id="train-options"></div>
    </section>

    <!-- –†–µ–∂–∏–º: –¢–µ—Å—Ç -->
    <section id="test-screen" class="screen">
        <div id="test-content">
            <!-- –¢–æ–ª—å–∫–æ —Å–ª–æ–≤–æ, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ -->
            <div class="question-card" id="test-q" style="font-weight: bold; font-size: 1.5rem;">...</div>
            
            <div class="options-grid" id="test-options"></div>
            
            <!-- –°—á–µ—Ç—á–∏–∫ –≤—ã–Ω–µ—Å–µ–Ω –≤–Ω–∏–∑ –ø–æ–¥ –≤–∞—Ä–∏–∞–Ω—Ç—ã -->
            <div id="test-counter-bottom" style="text-align: center; margin-top: 20px; color: var(--text-dim); font-size: 0.9rem;">
                –í–æ–ø—Ä–æ—Å 1 –∏–∑ 10
            </div>
        </div>
        <div id="test-results" class="hidden" style="text-align: center;">
            <h1 style="font-size: 3rem; color: var(--accent)" id="test-score-val">0%</h1>
            <p>–†–µ–∑—É–ª—å—Ç–∞—Ç —ç–∫–∑–∞–º–µ–Ω–∞</p>
            <button class="primary-btn" onclick="initTest()" style="margin-top: 20px">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>
    </section>

    <!-- –†–µ–∂–∏–º: –ò–ò -->
    <section id="ai-screen" class="screen">
        <textarea id="ai-input" class="ai-textarea" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '15 —Å–ª–æ–≤ –ø—Ä–æ —Ñ–∏–Ω–∞–Ω—Å—ã' –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç..."></textarea>
        <button class="primary-btn" id="ai-btn" onclick="handleAI()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏</button>
        <div id="loader" class="hidden">–ò–ò –¥—É–º–∞–µ—Ç... üß†‚ú®</div>
    </section>
</div>

<script>
    // --- FIREBASE –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    const firebaseConfig = {
        apiKey: "AIzaSyB0rdcOyeV1nOGNHueIBFRBD9qFvZl4LXM",
        authDomain: "slova-2581b.firebaseapp.com",
        projectId: "slova-2581b",
        storageBucket: "slova-2581b.firebasestorage.app",
        messagingSenderId: "721297377916",
        appId: "1:721297377916:web:04b2aa9adb0c5e2e3cd7f9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- –°–û–°–¢–û–Ø–ù–ò–ï ---
    let words = [{english: "Start here", russian: "–ù–∞—á–Ω–∏ –≤ —Ä–µ–∂–∏–º–µ –ò–ò"}];
    let currentIndex = 0;
    let testSession = { current: 0, score: 0, data: [] };

    // --- –¢–ê–ë–´ ---
    function switchTab(screenId, btn) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(screenId + '-screen').classList.add('active');
        btn.classList.add('active');

        if(screenId === 'train') initTraining();
        if(screenId === 'test') initTest();
    }

    // --- –ü–†–û–°–ú–û–¢–† –ö–ê–†–¢–û–ß–ï–ö ---
    function updateLearnUI() {
        if(!words.length) return;
        const w = words[currentIndex];
        document.getElementById('learn-en').innerText = w.english;
        document.getElementById('learn-ru').innerText = w.russian;
        document.getElementById('learn-counter').innerText = `${currentIndex + 1} / ${words.length}`;
        document.querySelector('.card-box').classList.remove('flipped');
    }

    function nextCard() { if(currentIndex < words.length - 1) { currentIndex++; updateLearnUI(); } }
    function prevCard() { if(currentIndex > 0) { currentIndex--; updateLearnUI(); } }

    // --- –¢–†–ï–ù–ò–†–û–í–ö–ê ---
    function initTraining() {
        if(words.length < 2) return document.getElementById('train-q').innerText = "–ú–∞–ª–æ —Å–ª–æ–≤ –¥–ª—è –∏–≥—Ä—ã";
        const correct = words[Math.floor(Math.random() * words.length)];
        document.getElementById('train-q').innerText = `–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è: ${correct.russian}?`;
        
        let options = [correct.english];
        while(options.length < 4 && options.length < words.length) {
            let rand = words[Math.floor(Math.random() * words.length)].english;
            if(!options.includes(rand)) options.push(rand);
        }
        options.sort(() => Math.random() - 0.5);

        const grid = document.getElementById('train-options');
        grid.innerHTML = '';
        options.forEach(opt => {
            const b = document.createElement('button');
            b.className = 'option-btn';
            b.innerText = opt;
            b.onclick = () => {
                if(opt === correct.english) {
                    b.classList.add('correct');
                    setTimeout(initTraining, 800);
                } else {
                    b.classList.add('wrong');
                }
            };
            grid.appendChild(b);
        });
    }

    // --- –¢–ï–°–¢ ---
    function initTest() {
        testSession = { current: 0, score: 0, data: [...words].sort(() => Math.random() - 0.5).slice(0, 10) };
        document.getElementById('test-content').classList.remove('hidden');
        document.getElementById('test-results').classList.add('hidden');
        renderTestStep();
    }

    function renderTestStep() {
        if(testSession.current >= testSession.data.length) {
            document.getElementById('test-content').classList.add('hidden');
            document.getElementById('test-results').classList.remove('hidden');
            document.getElementById('test-score-val').innerText = Math.round((testSession.score / testSession.data.length) * 100) + "%";
            return;
        }
        const w = testSession.data[testSession.current];
        document.getElementById('test-q').innerText = `(${testSession.current + 1}/10) –ü–µ—Ä–µ–≤–æ–¥ —Å–ª–æ–≤–∞: ${w.russian}`;
        
        let opts = [w.english];
        while(opts.length < 4 && opts.length < words.length) {
            let r = words[Math.floor(Math.random() * words.length)].english;
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5);

        const grid = document.getElementById('test-options');
        grid.innerHTML = '';
        opts.forEach(o => {
            const b = document.createElement('button');
            b.className = 'option-btn';
            b.innerText = o;
            b.onclick = () => {
                if(o === w.english) testSession.score++;
                testSession.current++;
                renderTestStep();
            };
            grid.appendChild(b);
        });
    }

    // --- –ò–ò –ì–ï–ù–ï–†–ê–¶–ò–Ø ---
    async function handleAI() {
        const inp = document.getElementById('ai-input').value;
        if(!inp) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É!");

        const btn = document.getElementById('ai-btn');
        const loader = document.getElementById('loader');
        btn.disabled = true;
        loader.classList.remove('hidden');

        try {
            const res = await fetch('/api/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ prompt: inp })
            });
            const data = await res.json();
            
            if(data.words && data.words.length > 0) {
                words = data.words;
                currentIndex = 0;
                updateLearnUI();
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É
                saveToFirebase(data.words);
                
                // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–∞—Ä—Ç–æ—á–∫–∞–º
                switchTab('learn', document.querySelectorAll('.tab-btn')[0]);
                document.getElementById('ai-input').value = '';
            } else {
                alert("–û—à–∏–±–∫–∞ –ò–ò: " + (data.error || "–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç"));
            }
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
        } finally {
            btn.disabled = false;
            loader.classList.add('hidden');
        }
    }

    // --- FIREBASE SAVE/LOAD ---
    async function saveToFirebase(wordArray) {
        try {
            const doc = await db.collection('flashcard-sets').add({
                words: wordArray,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            const newUrl = window.location.origin + window.location.pathname + '?id=' + doc.id;
            window.history.pushState({}, '', newUrl);
            document.getElementById('share-link').classList.remove('hidden');
        } catch (e) { console.error("Firebase save error", e); }
    }

    async function loadFromFirebase(id) {
        try {
            const doc = await db.collection('flashcard-sets').doc(id).get();
            if(doc.exists) {
                words = doc.data().words;
                currentIndex = 0;
                updateLearnUI();
                document.getElementById('share-link').classList.remove('hidden');
            }
        } catch (e) { console.error("Load error", e); }
    }

    function copyLink() {
        navigator.clipboard.writeText(window.location.href);
        alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! üîó");
    }

    // --- –°–¢–ê–†–¢ ---
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        if(id) loadFromFirebase(id);
        else updateLearnUI();
    };
</script>

</body>
</html>

